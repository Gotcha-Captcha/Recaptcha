# 전처리 계획 (비판적 검토 및 개선안)

## 🔍 비판적 검토

### ❌ 문제점 및 개선 필요 사항

1. **타일 분할 (Segmentation)**
   - **문제**: reCAPTCHA 데이터셋은 이미 개별 타일로 나뉘어 있을 가능성이 높음
   - **해결**: 데이터셋 구조를 먼저 확인하고, 필요시에만 분할 수행
   - **비판**: 불필요한 분할은 정보 손실을 야기할 수 있음

2. **고정 크기 리사이징**
   - **문제**: 64x64는 너무 작아서 LBP 질감 정보 손실, 128x128은 HOG 계산량 증가
   - **해결**: 96x96 또는 112x112로 절충안 제시 (실험적으로 최적값 찾기)
   - **비판**: config.yaml에 224x224로 설정되어 있으나, 이는 전통적 ML에 비해 큼

3. **가우시안 블러**
   - **문제**: 모든 이미지에 동일하게 적용하면 중요한 엣지 정보 손실 가능
   - **해결**: 노이즈 레벨을 먼저 측정하고, 필요시에만 선택적 적용
   - **비판**: 너무 강한 블러는 HOG 특징을 약화시킴

4. **CLAHE 파라미터**
   - **문제**: clip_limit와 tile_grid_size를 고정하면 다양한 이미지에 부적합
   - **해결**: 이미지 밝기 분포를 분석하여 적응적 파라미터 선택
   - **비판**: 과도한 CLAHE는 인위적인 아티팩트 생성

5. **HSV 변환**
   - **문제**: Lab 색공간도 고려해야 함 (색상 인식 정확도가 더 높을 수 있음)
   - **해결**: config에서 선택 가능하도록, 실험적으로 비교
   - **비판**: 모든 특징 추출에 HSV가 필요한 것은 아님 (HOG는 grayscale 사용)

6. **감마 교정**
   - **문제**: 모든 이미지에 동일한 감마 적용은 위험
   - **해결**: 밝기 분포 히스토그램 분석 후, 어두운 이미지에만 선택적 적용
   - **비판**: 감마 < 1은 노이즈를 증폭시킬 수 있음

7. **정규화**
   - **문제**: 0-1 정규화는 필수이지만, 특징 추출 전/후 시점이 중요
   - **해결**: 픽셀 값 정규화는 전처리 단계, 특징 벡터 정규화는 학습 단계에서 수행
   - **비판**: 정규화 방법도 StandardScaler vs MinMaxScaler 선택 필요

---

## ✅ 개선된 전처리 파이프라인

### **단계 0: 데이터셋 구조 분석** (NEW)
- 이미지가 이미 타일로 나뉘어 있는지 확인
- 이미지 크기 분포 분석
- 밝기 분포 히스토그램 분석
- 노이즈 레벨 측정 (표준편차 기반)

### **단계 1: 선택적 타일 분할**
- **조건부 적용**: 이미지가 200x200 이상이고 타일로 나뉘지 않은 경우만
- **그리드 크기**: 3x3 (9개) 또는 4x4 (16개) - config에서 설정
- **리사이징**: 타일 크기를 96x96으로 통일 (HOG와 LBP 균형)

### **단계 2: 적응적 노이즈 제거**
- **노이즈 측정**: 이미지별 표준편차 계산
- **조건부 가우시안 블러**: 
  - 노이즈 레벨이 threshold 이상인 경우만 적용
  - 커널 크기: (3, 3) 또는 (5, 5) - 작은 커널로 보수적 적용
- **대안**: Bilateral Filter (엣지 보존하면서 노이즈 제거)

### **단계 3: 적응적 CLAHE**
- **밝기 분포 분석**: 이미지별 평균 밝기 계산
- **파라미터 조정**:
  - clip_limit: 2.0 (기본) → 어두운 이미지는 3.0
  - tile_grid_size: (8, 8) (기본) → 작은 이미지는 (4, 4)
- **선택적 적용**: 밝기 분포가 균등한 이미지는 스킵

### **단계 4: 색상 공간 변환 (병렬 처리)**
- **HSV 변환**: Color Histogram 특징 추출용
- **Lab 변환**: 색상 인식 정확도 향상 (선택적)
- **Grayscale 변환**: HOG, LBP, Texture 특징 추출용
- **모두 저장**: 각 색상 공간별 이미지 저장 (특징 추출 단계에서 선택)

### **단계 5: 선택적 감마 교정**
- **밝기 분석**: 이미지별 평균 밝기 < 100인 경우만
- **감마 값**: 0.7 ~ 0.9 (어두운 부분 밝게)
- **주의**: 노이즈 증폭 방지를 위해 가우시안 블러 후 적용

### **단계 6: 픽셀 값 정규화**
- **Min-Max 정규화**: 0-255 → 0-1 범위로 변환
- **저장 형식**: float32로 저장 (메모리 효율)

### **단계 7: 메타데이터 생성**
- 이미지 경로, 레이블, 전처리 파라미터 기록
- 전처리 통계 저장 (평균 밝기, 노이즈 레벨 등)

---

## 📊 시각화 계획

### **1. 데이터셋 구조 분석 시각화**
- 이미지 크기 분포 히스토그램
- 밝기 분포 히스토그램 (전체 이미지)
- 노이즈 레벨 분포 히스토그램

### **2. 전처리 단계별 비교**
- 원본 vs 타일 분할 후
- 원본 vs 노이즈 제거 후
- 원본 vs CLAHE 후
- 원본 vs 감마 교정 후
- 원본 vs 최종 전처리 결과

### **3. 색상 공간 변환 시각화**
- RGB → HSV 변환 (H, S, V 채널 분리 표시)
- RGB → Lab 변환 (L, a, b 채널 분리 표시)
- RGB → Grayscale 변환

### **4. 통계 리포트**
- 전처리 전/후 통계 비교 (평균 밝기, 대비, 표준편차)
- 클래스별 전처리 효과 비교
- 전처리 파라미터 분포 (적용된 노이즈 제거, CLAHE, 감마 교정 비율)

---

## ⚙️ config.yaml 업데이트 계획

```yaml
preprocessing:
  # 이미지 크기 설정
  target_size: [96, 96]  # HOG와 LBP 균형을 위한 크기
  resize_method: "bilinear"  # bilinear, nearest, cubic
  
  # 타일 분할 (조건부)
  tile_segmentation:
    enabled: false  # 데이터셋 구조 확인 후 결정
    grid_size: [3, 3]  # 3x3 = 9개 타일
    min_image_size: 200  # 이 크기 이상일 때만 분할
  
  # 노이즈 제거 (조건부)
  noise_reduction:
    enabled: true
    method: "gaussian"  # gaussian, bilateral
    threshold: 15.0  # 표준편차가 이 값 이상이면 적용
    gaussian_kernel: [3, 3]  # 작은 커널로 보수적 적용
    bilateral_d: 9  # bilateral filter 파라미터
    bilateral_sigma_color: 75
    bilateral_sigma_space: 75
  
  # CLAHE (적응적)
  clahe:
    enabled: true
    clip_limit: 2.0  # 기본값, 어두운 이미지는 3.0
    tile_grid_size: [8, 8]  # 기본값, 작은 이미지는 [4, 4]
    brightness_threshold: 100  # 평균 밝기가 이 값 이하면 clip_limit 증가
  
  # 색상 공간 변환
  color_space:
    hsv: true  # Color Histogram용
    lab: false  # 선택적 (실험용)
    grayscale: true  # HOG, LBP, Texture용
  
  # 감마 교정 (선택적)
  gamma_correction:
    enabled: true
    threshold: 100  # 평균 밝기가 이 값 이하면 적용
    gamma: 0.8  # 어두운 부분 밝게 (0.7 ~ 0.9)
  
  # 정규화
  normalization:
    method: "minmax"  # minmax, standard
    range: [0.0, 1.0]  # MinMax 정규화 범위
  
  # 데이터 증강 (선택적)
  augmentation:
    enabled: false  # 특징 추출 전에는 비활성화 (학습 시에만)
    rotation_range: 15
    horizontal_flip: true
    brightness_range: [0.8, 1.2]
  
  # 시각화 설정
  visualization:
    num_samples: 10  # 각 단계별 비교할 샘플 수
    save_intermediate: false  # 중간 단계 이미지 저장 여부
```

---

## 🎯 구현 우선순위

### **Phase 1: 기본 전처리** (필수)
1. 이미지 크기 통일 (리사이징)
2. 색상 공간 변환 (HSV, Grayscale)
3. CLAHE (기본 파라미터)
4. 정규화
5. 메타데이터 생성

### **Phase 2: 적응적 전처리** (성능 향상)
1. 데이터셋 구조 분석
2. 노이즈 레벨 측정 및 조건부 가우시안 블러
3. 적응적 CLAHE 파라미터
4. 선택적 감마 교정

### **Phase 3: 고급 기능** (선택적)
1. 타일 분할 (필요시)
2. Bilateral Filter (노이즈 제거 대안)
3. Lab 색공간 변환

---

## 🔬 실험 계획

### **실험 1: 이미지 크기 최적화**
- 64x64, 96x96, 112x112, 128x128 비교
- HOG 특징 품질 vs 계산량 트레이드오프
- LBP 질감 정보 보존도 측정

### **실험 2: 전처리 조합 최적화**
- 노이즈 제거 유무
- CLAHE 파라미터 조합
- 감마 교정 효과
- A/B 테스트로 분류 성능 비교

### **실험 3: 색상 공간 비교**
- HSV vs Lab vs RGB
- Color Histogram 특징 품질 비교

---

## 📝 Clean Code 원칙 적용

1. **단일 책임 원칙**: 각 전처리 단계를 별도 함수로 분리
2. **DRY**: 공통 로직 (이미지 로드, 저장) 재사용
3. **의미 있는 이름**: `apply_adaptive_clahe()`, `measure_noise_level()`
4. **에러 처리**: 이미지 로드 실패, 전처리 실패 시 로깅
5. **문서화**: 각 함수에 docstring, 파라미터 설명
6. **테스트 가능성**: 각 단계를 독립적으로 테스트 가능하도록

---

## 🚀 다음 단계

1. `config.yaml` 업데이트 (위의 preprocessing 섹션 추가)
2. `src/preprocess.py` 구현 시작
3. 데이터셋 구조 확인 후 타일 분할 필요 여부 결정
4. 기본 전처리 구현 후 시각화로 검증
5. 적응적 전처리 단계별 추가
